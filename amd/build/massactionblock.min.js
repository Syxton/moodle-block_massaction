function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("block_massaction/massactionblock",["exports","./checkboxmanager","core/str","core/ajax","core/pending"],(function(_exports,_checkboxmanager,Str,_ajax,_pending){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.usedMoodleCssClasses=_exports.setSectionSelection=_exports.init=_exports.cssIds=_exports.constants=void 0,_checkboxmanager=_interopRequireDefault(_checkboxmanager),Str=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Str),_ajax=_interopRequireDefault(_ajax),_pending=_interopRequireDefault(_pending);var sectionBoxes={},isRebuilding=!1,usedMoodleCssClasses={SECTION_NAME:"sectionname",MODULE_ID_PREFIX:"module-",SPINNER:"spinner",DNDUPLOAD:"dndupload-progress-outer"};_exports.usedMoodleCssClasses=usedMoodleCssClasses;var cssIds={SELECT_ALL_LINK:"block-massaction-control-selectall",DESELECT_ALL_LINK:"block-massaction-control-deselectall",HIDE_LINK:"block-massaction-action-hide",SHOW_LINK:"block-massaction-action-show",MAKE_AVAILABLE_LINK:"block-massaction-action-makeavailable",DUPLICATE_LINK:"block-massaction-action-duplicate",DELETE_LINK:"block-massaction-action-delete",MOVELEFT_LINK:"block-massaction-action-moveleft",MOVERIGHT_LINK:"block-massaction-action-moveright",MOVETO_ICON_LINK:"block-massaction-action-moveto",DUPLICATETO_ICON_LINK:"block-massaction-action-duplicateto",SECTION_SELECT:"block-massaction-control-section-list-select",MOVETO_SELECT:"block-massaction-control-section-list-moveto",DUPLICATETO_SELECT:"block-massaction-control-section-list-duplicateto",BOX_ID_PREFIX:"block-massaction-module-selector-",CHECKBOX_CLASS:"block-massaction-checkbox",HIDDEN_FIELD_REQUEST_INFORMATION:"block-massaction-control-request",ACTION_FORM:"block-massaction-control-form"};_exports.cssIds=cssIds;var constants={SECTION_SELECT_DESCRIPTION_VALUE:"description",SECTION_NUMBER_ALL_PLACEHOLDER:"all",CHECKBOX_DESCRIPTION_SUFFIX:" Checkbox"};_exports.constants=constants;var fn,_ref,actions_HIDE="hide",actions_SHOW="show",actions_MAKE_AVAILABLE="makeavailable",actions_DUPLICATE="duplicate",actions_DELETE="delete",actions_MOVE_LEFT="moveleft",actions_MOVE_RIGHT="moveright",actions_MOVE_TO="moveto",actions_DUPLICATE_TO="duplicateto",init=(fn=regeneratorRuntime.mark((function _callee(courseId){var _document$getElementB,_document$getElementB2,_document$getElementB3,_document$getElementB4,_document$getElementB5,_document$getElementB6,_document$getElementB7,_document$getElementB8,_document$getElementB9,_document$getElementB10,_document$getElementB11,pendingPromise,observer;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:pendingPromise=new _pending.default("block_massaction/init"),rebuildSections(courseId),observer=new MutationObserver((function(mutations){var mutationsSection=(mutations=mutations.filter((function(mutation){return"childList"===mutation.type}))).filter((function(mutation){return mutation.addedNodes&&mutation.addedNodes.length>0}));if(2===mutationsSection.length&&mutationsSection.every((function(mutation){return mutation.target.classList.contains(usedMoodleCssClasses.SECTION_NAME)})))rebuildSections(courseId);else{var mutationsActivities=mutations.filter((function(mutation){return mutation.removedNodes&&mutation.removedNodes.length>0})),allRemovedNodes=[];mutationsActivities.forEach((function(item){var descendants=getAllDescendants(item.removedNodes);descendants&&(allRemovedNodes=allRemovedNodes.concat(descendants))})),allRemovedNodes.length>0&&allRemovedNodes.filter((function(node){return 3!==node.nodeType})).forEach((function(node){(node.classList&&node.classList.contains(usedMoodleCssClasses.SPINNER)||node.classList.contains(usedMoodleCssClasses.DNDUPLOAD))&&rebuildSections(courseId)}))}})),document.addEventListener("readystatechange",(function(event){"complete"===event.target.readyState&&setTimeout((function(){return observer.observe(document.body,{subtree:!0,childList:!0,attributes:!1,characterData:!1})}),1e3)})),null===(_document$getElementB=document.getElementById(cssIds.SELECT_ALL_LINK))||void 0===_document$getElementB||_document$getElementB.addEventListener("click",(function(){return setSectionSelection(!0,constants.SECTION_NUMBER_ALL_PLACEHOLDER)}),!1),null===(_document$getElementB2=document.getElementById(cssIds.DESELECT_ALL_LINK))||void 0===_document$getElementB2||_document$getElementB2.addEventListener("click",(function(){return setSectionSelection(!1,constants.SECTION_NUMBER_ALL_PLACEHOLDER)}),!1),null===(_document$getElementB3=document.getElementById(cssIds.HIDE_LINK))||void 0===_document$getElementB3||_document$getElementB3.addEventListener("click",(function(){return submitAction(actions_HIDE)}),!1),null===(_document$getElementB4=document.getElementById(cssIds.SHOW_LINK))||void 0===_document$getElementB4||_document$getElementB4.addEventListener("click",(function(){return submitAction(actions_SHOW)}),!1),null===(_document$getElementB5=document.getElementById(cssIds.MAKE_AVAILABLE_LINK))||void 0===_document$getElementB5||_document$getElementB5.addEventListener("click",(function(){return submitAction(actions_MAKE_AVAILABLE)}),!1),null===(_document$getElementB6=document.getElementById(cssIds.DUPLICATE_LINK))||void 0===_document$getElementB6||_document$getElementB6.addEventListener("click",(function(){return submitAction(actions_DUPLICATE)}),!1),null===(_document$getElementB7=document.getElementById(cssIds.DELETE_LINK))||void 0===_document$getElementB7||_document$getElementB7.addEventListener("click",(function(){return submitAction(actions_DELETE)}),!1),null===(_document$getElementB8=document.getElementById(cssIds.MOVELEFT_LINK))||void 0===_document$getElementB8||_document$getElementB8.addEventListener("click",(function(){return submitAction(actions_MOVE_LEFT)}),!1),null===(_document$getElementB9=document.getElementById(cssIds.MOVERIGHT_LINK))||void 0===_document$getElementB9||_document$getElementB9.addEventListener("click",(function(){return submitAction(actions_MOVE_RIGHT)}),!1),null===(_document$getElementB10=document.getElementById(cssIds.MOVETO_ICON_LINK))||void 0===_document$getElementB10||_document$getElementB10.addEventListener("click",(function(){return submitAction(actions_MOVE_TO)}),!1),null===(_document$getElementB11=document.getElementById(cssIds.DUPLICATETO_ICON_LINK))||void 0===_document$getElementB11||_document$getElementB11.addEventListener("click",(function(){return submitAction(actions_DUPLICATE_TO)}),!1),pendingPromise.resolve();case 16:case"end":return _context.stop()}}),_callee)})),_ref=function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))},function(_x){return _ref.apply(this,arguments)});_exports.init=init;var setSectionSelection=function(value,sectionNumber){var boxIds=[];if(void 0===sectionNumber||sectionNumber!==constants.SECTION_SELECT_DESCRIPTION_VALUE){if(void 0!==sectionNumber&&sectionNumber===constants.SECTION_NUMBER_ALL_PLACEHOLDER)for(var sectionId in sectionBoxes)for(var j=0;j<sectionBoxes[sectionId].length;j++)boxIds.push(sectionBoxes[sectionId][j].boxId);else sectionBoxes[sectionNumber].forEach((function(box){return boxIds.push(box.boxId)}));for(var i=0;i<boxIds.length;i++)document.getElementById(boxIds[i]).checked=value}};_exports.setSectionSelection=setSectionSelection;var submitAction=function(action){var submitData={action:action,moduleIds:[]};for(var sectionNumber in sectionBoxes)for(var i=0;i<sectionBoxes[sectionNumber].length;i++){document.getElementById(sectionBoxes[sectionNumber][i].boxId).checked&&submitData.moduleIds.push(sectionBoxes[sectionNumber][i].moduleId)}if(0===submitData.moduleIds.length)return displayError(Str.get_string("noitemselected","block_massaction")),!1;switch(action){case actions_HIDE:case actions_SHOW:case actions_MAKE_AVAILABLE:case actions_DUPLICATE:case actions_MOVE_LEFT:case actions_MOVE_RIGHT:case actions_DELETE:break;case actions_MOVE_TO:if(submitData.moveToTarget=document.getElementById(cssIds.MOVETO_SELECT).value,""===submitData.moveToTarget.trim())return displayError(Str.get_string("nomovingtargetselected","block_massaction")),!1;break;case actions_DUPLICATE_TO:if(submitData.duplicateToTarget=document.getElementById(cssIds.DUPLICATETO_SELECT).value,""===submitData.duplicateToTarget.trim())return displayError(Str.get_string("nomovingtargetselected","block_massaction")),!1;break;default:return displayError("Unknown action: "+action+". Coding error."),!1}return document.getElementById(cssIds.HIDDEN_FIELD_REQUEST_INFORMATION).value=JSON.stringify(submitData),document.getElementById(cssIds.ACTION_FORM).submit(),!0},displayError=function(errorText){Promise.resolve([Str.get_string("error","core"),errorText,Str.get_string("back","core")]).then((function(text){return require(["core/notification"],(function(notification){notification.alert(text[0],text[1],text[2]).then().catch()})),null})).catch()},rebuildSections=function(courseId){isRebuilding||(isRebuilding=!0,setTimeout((function(){var promises=_ajax.default.call([{methodname:"block_massaction_get_sections",args:{courseId:courseId}},{methodname:"block_massaction_get_modulesinfo",args:{courseId:courseId}}]);Promise.all([promises[0],promises[1]]).then((function(data){return sectionBoxes=(0,_checkboxmanager.default)(data[0],data[1]),isRebuilding=!1,!0})).catch((function(){return isRebuilding=!1,!1}))}),1e3))},getAllDescendants=function(nodes){for(var allNodes=[],getDescendants=function getDescendants(node){for(var i=0;i<node.childNodes.length;i++){var child=node.childNodes[i];getDescendants(child),allNodes.push(child)}},j=0;j<nodes.length;j++)getDescendants(nodes[j]);return allNodes}}));

//# sourceMappingURL=massactionblock.min.js.map