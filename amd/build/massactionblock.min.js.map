{"version":3,"file":"massactionblock.min.js","sources":["../src/massactionblock.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main module for the massaction block.\n *\n * @module     block_massaction/massactionblock\n * @copyright  2022 ISB Bayern\n * @author     Philipp Memmel\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as checkboxmanager from 'block_massaction/checkboxmanager';\nimport * as Str from 'core/str';\nimport Log from 'core/log';\nimport Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport {getCurrentCourseEditor} from 'core_courseformat/courseeditor';\nimport {disableStickyFooter} from 'core/sticky-footer';\n\nexport const usedMoodleCssClasses = {\n    ACTIVITY_ITEM: '.activity-item',\n    SECTION_NAME: 'sectionname',\n    MODULE_ID_PREFIX: 'module-',\n    BOX_ID_PREFIX: 'cmCheckbox'\n};\n\nexport const cssIds = {\n    BLOCK_CONTENT: 'block-massaction',\n    SELECT_ALL_LINK: 'block-massaction-control-selectall',\n    DESELECT_ALL_LINK: 'block-massaction-control-deselectall',\n    HIDE_LINK: 'block-massaction-action-hide',\n    SHOW_LINK: 'block-massaction-action-show',\n    MAKE_AVAILABLE_LINK: 'block-massaction-action-makeavailable',\n    DUPLICATE_LINK: 'block-massaction-action-duplicate',\n    DELETE_LINK: 'block-massaction-action-delete',\n    SHOW_DESCRIPTION_LINK: 'block-massaction-action-showdescription',\n    HIDE_DESCRIPTION_LINK: 'block-massaction-action-hidedescription',\n    CONTENT_CHANGED_NOTIFICATION_LINK: 'block-massaction-action-contentchangednotification',\n    MOVELEFT_LINK: 'block-massaction-action-moveleft',\n    MOVERIGHT_LINK: 'block-massaction-action-moveright',\n    MOVETO_ICON_LINK: 'block-massaction-action-moveto',\n    DUPLICATETO_ICON_LINK: 'block-massaction-action-duplicateto',\n    DUPLICATE_TO_COURSE_ICON_LINK: 'block-massaction-action-duplicatetocourse',\n    SECTION_SELECT: 'block-massaction-control-section-list-select',\n    MOVETO_SELECT: 'block-massaction-control-section-list-moveto',\n    DUPLICATETO_SELECT: 'block-massaction-control-section-list-duplicateto',\n    HIDDEN_FIELD_REQUEST_INFORMATION: 'block-massaction-control-request',\n    ACTION_FORM: 'block-massaction-control-form',\n};\n\nexport const constants = {\n    SECTION_SELECT_DESCRIPTION_VALUE: 'description',\n    SECTION_NUMBER_ALL_PLACEHOLDER: 'all',\n};\n\nconst actions = {\n    HIDE: 'hide',\n    SHOW: 'show',\n    MAKE_AVAILABLE: 'makeavailable',\n    DUPLICATE: 'duplicate',\n    DELETE: 'delete',\n    SHOW_DESCRIPTION: 'showdescription',\n    HIDE_DESCRIPTION: 'hidedescription',\n    MOVE_LEFT: 'moveleft',\n    MOVE_RIGHT: 'moveright',\n    CONTENT_CHANGED_NOTIFICATION: 'contentchangednotification',\n    MOVE_TO: 'moveto',\n    DUPLICATE_TO: 'duplicateto',\n    DUPLICATE_TO_COURSE: 'duplicatetocourse',\n};\n\n/**\n * Initialize the mass-action block.\n */\nexport const init = async() => {\n    const pendingPromise = new Pending('block_massaction/init');\n\n    const editor = getCurrentCourseEditor();\n    // As soon as courseeditor is available, do some initial setup.\n    editor.stateManager.getInitialPromise()\n        .then(() => {\n            // Initialize the checkbox manager.\n            checkboxmanager.initCheckboxManager();\n\n            // Enable bulk editing state.\n            editor.dispatch('bulkEnable', true);\n\n            // Remove sticky footer.\n            disableStickyFooter();\n\n            return true;\n        })\n        .then(() => {\n            // Show module tools by removing the classes that hides them.\n            let elem;\n            for (elem of document.getElementsByClassName(\"bulk-hidden\")) {\n                elem.classList.remove(\"bulk-hidden\");\n            }\n\n            for (elem of document.querySelectorAll('[data-inplaceeditablelink]')) {\n                elem.classList.remove(\"d-none\");\n            }\n            return true;\n        })\n        .catch(error => Log.debug(error));\n\n    document.getElementById(cssIds.SELECT_ALL_LINK)?.addEventListener('click',\n        () => checkboxmanager.setSectionSelection(true, constants.SECTION_NUMBER_ALL_PLACEHOLDER), false);\n\n    document.getElementById(cssIds.DESELECT_ALL_LINK)?.addEventListener('click',\n        () => checkboxmanager.setSectionSelection(false, constants.SECTION_NUMBER_ALL_PLACEHOLDER), false);\n\n    document.getElementById(cssIds.HIDE_LINK)?.addEventListener('click',\n        () => submitAction(actions.HIDE), false);\n\n    document.getElementById(cssIds.SHOW_LINK)?.addEventListener('click',\n        () => submitAction(actions.SHOW), false);\n\n    document.getElementById(cssIds.MAKE_AVAILABLE_LINK)?.addEventListener('click',\n        () => submitAction(actions.MAKE_AVAILABLE), false);\n\n    document.getElementById(cssIds.DUPLICATE_LINK)?.addEventListener('click',\n        () => submitAction(actions.DUPLICATE), false);\n\n    document.getElementById(cssIds.DELETE_LINK)?.addEventListener('click',\n        () => submitAction(actions.DELETE), false);\n\n    document.getElementById(cssIds.SHOW_DESCRIPTION_LINK)?.addEventListener('click',\n        () => submitAction(actions.SHOW_DESCRIPTION), false);\n\n    document.getElementById(cssIds.HIDE_DESCRIPTION_LINK)?.addEventListener('click',\n        () => submitAction(actions.HIDE_DESCRIPTION), false);\n\n    document.getElementById(cssIds.CONTENT_CHANGED_NOTIFICATION_LINK)?.addEventListener('click',\n        () => submitAction(actions.CONTENT_CHANGED_NOTIFICATION), false);\n\n    document.getElementById(cssIds.MOVELEFT_LINK)?.addEventListener('click',\n        () => submitAction(actions.MOVE_LEFT), false);\n\n    document.getElementById(cssIds.MOVERIGHT_LINK)?.addEventListener('click',\n        () => submitAction(actions.MOVE_RIGHT), false);\n\n    document.getElementById(cssIds.MOVETO_ICON_LINK)?.addEventListener('click',\n        () => submitAction(actions.MOVE_TO), false);\n\n    document.getElementById(cssIds.DUPLICATETO_ICON_LINK)?.addEventListener('click',\n        () => submitAction(actions.DUPLICATE_TO), false);\n\n    document.getElementById(cssIds.DUPLICATE_TO_COURSE_ICON_LINK)?.addEventListener('click',\n        () => submitAction(actions.DUPLICATE_TO_COURSE), false);\n\n    pendingPromise.resolve();\n};\n\n/**\n * Submit the selected action to server.\n *\n * @param {string} action\n * @return {boolean} true if action was successful, false otherwise\n */\nconst submitAction = (action) => {\n    const submitData = {\n        'action': action,\n        'moduleIds': []\n    };\n\n    submitData.moduleIds = checkboxmanager.getSelectedModIds();\n\n    // Verify that at least one checkbox is checked.\n    if (submitData.moduleIds.length === 0) {\n        displayError(Str.get_string('noitemselected', 'block_massaction'));\n        return false;\n    }\n\n    // Prep the submission.\n    switch (action) {\n        case actions.HIDE:\n        case actions.SHOW:\n        case actions.MAKE_AVAILABLE:\n        case actions.DUPLICATE:\n        case actions.DUPLICATE_TO_COURSE:\n        case actions.CONTENT_CHANGED_NOTIFICATION:\n        case actions.MOVE_LEFT:\n        case actions.MOVE_RIGHT:\n        case actions.DELETE:\n        case actions.SHOW_DESCRIPTION:\n        case actions.HIDE_DESCRIPTION:\n            break;\n\n        case actions.MOVE_TO:\n            // Get the target section.\n            submitData.moveToTarget = document.getElementById(cssIds.MOVETO_SELECT).value;\n            if (submitData.moveToTarget.trim() === '') {\n                displayError(Str.get_string('nomovingtargetselected', 'block_massaction'));\n                return false;\n            }\n            break;\n\n        case actions.DUPLICATE_TO:\n            // Get the target section.\n            submitData.duplicateToTarget = document.getElementById(cssIds.DUPLICATETO_SELECT).value;\n            if (submitData.duplicateToTarget.trim() === '') {\n                displayError(Str.get_string('nomovingtargetselected', 'block_massaction'));\n                return false;\n            }\n            break;\n        default:\n            displayError('Unknown action: ' + action + '. Coding error.');\n            return false;\n    }\n    // Set the form value and submit.\n    document.getElementById(cssIds.HIDDEN_FIELD_REQUEST_INFORMATION).value = JSON.stringify(submitData);\n    document.getElementById(cssIds.ACTION_FORM).submit();\n    return true;\n};\n\nconst displayError = (errorText) => {\n    Promise.resolve([Str.get_string('error', 'core'), errorText, Str.get_string('back', 'core')])\n        .then(text => Notification.alert(text[0], text[1], text[2]))\n        .catch(error => Log.debug(error));\n};\n"],"names":["ACTIVITY_ITEM","SECTION_NAME","MODULE_ID_PREFIX","BOX_ID_PREFIX","cssIds","BLOCK_CONTENT","SELECT_ALL_LINK","DESELECT_ALL_LINK","HIDE_LINK","SHOW_LINK","MAKE_AVAILABLE_LINK","DUPLICATE_LINK","DELETE_LINK","SHOW_DESCRIPTION_LINK","HIDE_DESCRIPTION_LINK","CONTENT_CHANGED_NOTIFICATION_LINK","MOVELEFT_LINK","MOVERIGHT_LINK","MOVETO_ICON_LINK","DUPLICATETO_ICON_LINK","DUPLICATE_TO_COURSE_ICON_LINK","SECTION_SELECT","MOVETO_SELECT","DUPLICATETO_SELECT","HIDDEN_FIELD_REQUEST_INFORMATION","ACTION_FORM","constants","SECTION_SELECT_DESCRIPTION_VALUE","SECTION_NUMBER_ALL_PLACEHOLDER","actions","async","pendingPromise","Pending","editor","stateManager","getInitialPromise","then","checkboxmanager","initCheckboxManager","dispatch","elem","document","getElementsByClassName","classList","remove","querySelectorAll","catch","error","Log","debug","getElementById","addEventListener","setSectionSelection","submitAction","resolve","action","submitData","moduleIds","getSelectedModIds","length","displayError","Str","get_string","moveToTarget","value","trim","duplicateToTarget","JSON","stringify","submit","errorText","Promise","text","Notification","alert"],"mappings":"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"}